{% extends 'base_v2.html' %}
{% block content %}

<div class="min-h-[80vh] px-4 py-6">
  <!-- Solde actuel -->
  <div class="card-gradient rounded-2xl p-6 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-white/80 text-sm">Solde actuel</p>
        <h2 class="text-2xl font-bold text-white">{{ session['user']['balance'] }} <span class="text-yellow-300">BTC</span></h2>
      </div>
      <div class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center">
        <i class="fas fa-wallet text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Formulaire de d√©p√¥t -->
  <div class="card">
    <div class="mb-6">
      <h2 class="text-xl font-bold mb-2">D√©p√¥t de fonds</h2>
      <p class="text-sm text-gray-600">1 FCFA = 1 Betcoin (BTC). Montant minimum : 100 FCFA</p>
    </div>

    <form id="depositForm" class="space-y-6">
      <!-- Num√©ro de t√©l√©phone -->
      <div class="form-group">
        <label class="form-label">Num√©ro de t√©l√©phone</label>
        <div class="relative">
          <i class="fas fa-phone absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="tel" 
                 id="phone" 
                 name="phone" 
                 class="form-input pl-10"
                 placeholder="Ex: 699123456" 
                 pattern="[6-9][0-9]{8}"
                 title="Entrez un num√©ro de t√©l√©phone valide"
                 required>
        </div>
      </div>

      <!-- Moyen de paiement -->
      <div class="form-group">
        <label class="form-label">Choisissez votre moyen de paiement</label>
        <div class="grid grid-cols-2 gap-4">
          <label class="card touch-scale relative cursor-pointer border-2 border-transparent transition-all duration-200">
            <input type="radio" 
                   id="operator_orange" 
                   name="operator" 
                   value="ORANGE" 
                   class="absolute opacity-0"
                   required>
            <div class="flex flex-col items-center p-4">
              <img src="../static/uploads/Orange-Money-Logo.png" 
                   alt="Orange Money" 
                   class="h-12 mb-2">
              <span class="text-sm font-medium">Orange Money</span>
            </div>
          </label>

          <label class="card touch-scale relative cursor-pointer border-2 border-transparent transition-all duration-200">
            <input type="radio" 
                   id="operator_mtn" 
                   name="operator" 
                   value="MTN" 
                   class="absolute opacity-0"
                   required>
            <div class="flex flex-col items-center p-4">
              <img src="../static/uploads/28-280910_595-x-842-25-logo-de-mtn-money.png" 
                   alt="MTN MoMo" 
                   class="h-12 mb-2">
              <span class="text-sm font-medium">MTN MoMo</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Montant -->
      <div class="form-group">
        <label class="form-label">Montant (FCFA)</label>
        <div class="relative">
          <i class="fas fa-money-bill absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="number" 
                 id="amount" 
                 name="amount" 
                 class="form-input pl-10"
                 min="100" 
                 value="100" 
                 required>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          <i class="fas fa-info-circle"></i>
          Montant minimum : 100 FCFA
        </p>
      </div>

      <!-- Bouton de soumission -->
      <button type="submit" class="btn gradient-primary text-white w-full">
        <i class="fas fa-plus-circle mr-2"></i>
        D√©poser maintenant
      </button>
    </form>

    <!-- Message de retour -->
    <div id="depositMessage" class="mt-6"></div>

    <!-- Zone USSD / QR (cach√©e par d√©faut, s'affiche apr√®s cr√©ation de la demande) -->
    <div id="ussdArea" class="mt-4 hidden bg-white p-4 rounded-lg shadow">
      <h4 class="font-semibold mb-2">Payer maintenant</h4>
      <p class="text-sm text-gray-600 mb-2">Cliquez sur "Payer maintenant" depuis votre t√©l√©phone pour ex√©cuter le code USSD, ou copiez le code dans le champ de composition de votre t√©l√©phone. Vous pouvez aussi scanner le QR.</p>
      <div class="flex items-center gap-3 mb-3">
        <div class="p-3 bg-gray-100 rounded">
          <div class="text-xs text-gray-500">Code USSD</div>
          <div id="ussdCode" class="font-mono mt-1">#150*1*1*655260684*100*2*1#</div>
        </div>
        <div>
          <a id="btnPay" class="btn btn-orange hidden px-4 py-2 mr-2" href="#">üìû Payer maintenant</a>
          <button id="btnCopy" class="px-3 py-2 border rounded">Copier</button>
          <button id="btnManual" class="px-3 py-2 border rounded hidden ml-2">Manuel</button>
        </div>
      </div>
      <div class="mt-3">
        <span class="inline-flex items-center px-2 py-1 rounded text-sm font-medium bg-red-100 text-red-700">
          <strong>En cas d'√©chec du d√©p√¥t, utilisez le bouton "Instructions" ci-dessus.</strong>
        </span>
      </div>
    </div>

    <!-- Instructions manuelles (cach√©es par d√©faut) -->
    <div id="manualInstructions" class="mt-4 hidden bg-white p-4 rounded-lg shadow">
      <h4 class="font-semibold mb-2">Instructions manuelles</h4>
      <div id="manualText" class="text-sm text-gray-600 mb-2">Suivez les instructions depuis votre application mobile:</div>
      <div class="flex gap-3">
        <button id="btnCloseManual" class="btn border">Retour</button>
      </div>
    </div>
  </div>

  <!-- Section FAQ -->

  <!-- Section FAQ -->
  <div class="mt-6 space-y-4">
    <div class="card">
      <h3 class="font-semibold mb-2 flex items-center gap-2">
        <i class="fas fa-clock text-indigo-600"></i>
        Combien de temps pour le traitement ?
      </h3>
      <p class="text-sm text-gray-600">Le d√©p√¥t est instantan√©. Les fonds sont disponibles d√®s la confirmation du paiement mobile.</p>
    </div>

    <div class="card">
      <h3 class="font-semibold mb-2 flex items-center gap-2">
        <i class="fas fa-shield-alt text-indigo-600"></i>
        Est-ce s√©curis√© ?
      </h3>
      <p class="text-sm text-gray-600">Oui, nous utilisons des services de paiement mobile certifi√©s et s√©curis√©s.</p>
    </div>
  </div>
</div>

<style>
  /* Style pour les cartes de paiement */
  input[type="radio"]:checked + div {
    box-shadow: 0 0 0 2px #4f46e5, 0 0 0 4px white;
  }
  
  /* Animation de loading */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .loading::after {
    content: "";
    position: absolute;
    width: 1rem;
    height: 1rem;
    top: calc(50% - 0.5rem);
    left: calc(50% - 0.5rem);
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
</style>

<script>
// G√©n√®re le code USSD en fonction de l'op√©rateur (modifiez les templates si besoin)
function generateUSSD(operator, phone, amount){
  if(operator === 'ORANGE'){
    return `#150*1*1*655260684*${amount}*2*1#`;
  } else if(operator === 'MTN'){
    // MTN requires the user's number in the code
    return `*126*${phone}*${amount}#`;
  }
  return null; // unknown operator -> let UI show manual instructions
}

function updateUSSDPreview(){
  const operator = document.querySelector('input[name="operator"]:checked')?.value;
  const phone = document.getElementById('phone').value.trim();
  const amount = parseInt(document.getElementById('amount').value || '0');
  const preview = document.getElementById('ussdCode');
  if(preview && operator && amount >= 100){
    const code = generateUSSD(operator, phone, amount);
    preview.innerText = code || 'Op√©rateur non standard ‚Äî voir instructions';
    document.getElementById('btnManual').classList.remove('hidden');
  }
}
['amount'].forEach(id => document.getElementById(id).addEventListener('input', updateUSSDPreview));
['operator_orange','operator_mtn'].forEach(id => document.getElementById(id).addEventListener('change', updateUSSDPreview));

// Manual instructions toggle
const btnManualEl = document.getElementById('btnManual');
const btnCloseManualEl = document.getElementById('btnCloseManual');
if(btnManualEl) btnManualEl.addEventListener('click', () => selectOperator('MANUAL'));
if(btnCloseManualEl) btnCloseManualEl.addEventListener('click', () => selectOperator('BACK'));

function selectOperator(mode){
  const manual = document.getElementById('manualInstructions');
  const ussdArea = document.getElementById('ussdArea');
  const manualText = document.getElementById('manualText');
  const phone = document.getElementById('phone').value.trim();
  const operator = document.querySelector('input[name="operator"]:checked')?.value;
  const amount = document.getElementById('amount').value;
  if(mode === 'MANUAL'){
    let text = '';
    if(operator === 'ORANGE'){
      text = `Ouvrez le clavier de votre t√©l√©phone et composez: #150*1*1*655260684*${amount}*2*1# puis validez.`;
    } else if(operator === 'MTN'){
      text = `Ouvrez le clavier de votre t√©l√©phone et composez: *126*${phone}*${amount}# puis validez.`;
    } else {
      text = `Ouvrez votre application mobile d'argent et effectuez un transfert de ${amount} FCFA vers le num√©ro 655260684 en indiquant votre nom d'utilisateur comme r√©f√©rence.`;
    }
    manualText.innerText = text;
    manual.classList.remove('hidden');
    ussdArea.classList.add('hidden');
  } else {
    manual.classList.add('hidden');
    ussdArea.classList.remove('hidden');
  }
}

// initial preview
updateUSSDPreview();

document.getElementById("depositForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const phone = document.getElementById("phone").value.trim();
  const operator = document.querySelector('input[name="operator"]:checked')?.value;
  const amount = parseInt(document.getElementById("amount").value);
  const msg = document.getElementById("depositMessage");


    // D√©sactive le bouton et ajoute l'animation de chargement
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    submitBtn.innerHTML = 'Traitement en cours...';
    
    try {
      const response = await fetch("/api/deposit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, operator, amount })
      });

      const result = await response.json();

      if (response.ok) {
        const tx = result.provider_tx_id || result.provider_txid || result.externalId || result.provider_tx_id;
        
        // Affiche le message de succ√®s
        msg.innerHTML = `
          <div class="bg-green-50 text-green-700 p-4 rounded-lg flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-check text-green-500"></i>
            </div>
            <div>
              <h4 class="font-medium">Paiement initi√© avec succ√®s !</h4>
              <p class="text-sm mt-1">${result.message || "Votre demande est enregistr√©e. Payer maintenant via votre t√©l√©phone ou scannez le QR."}</p>
            </div>
          </div>
        `;
        
        // G√©n√©rer l'USSD et le QR permettant d'effectuer le paiement depuis le mobile
        const ussdArea = document.getElementById('ussdArea');
        if (ussdArea) {
          const operatorVal = operator;
          const phoneVal = phone;
          const amountVal = amount;
          const ussd = generateUSSD(operatorVal, phoneVal, amountVal);
          document.getElementById('ussdCode').innerText = ussd || 'Op√©rateur non standard ‚Äî voir instructions';
          const payBtn = document.getElementById('btnPay');
          if(ussd){
            const telURI = 'tel:' + encodeURIComponent(ussd);
            payBtn.href = telURI;
            payBtn.classList.remove('hidden');
            document.getElementById('btnCopy').onclick = () => { navigator.clipboard.writeText(ussd); alert('USSD copi√©'); };

            // Auto-dial sur mobile : tente d'ouvrir le dialer automatiquement
            const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
            if(isMobile){
              // petit d√©lai pour afficher le feedback avant de lancer
              setTimeout(() => { window.location.href = telURI; }, 600);
            }
          } else {
            payBtn.classList.add('hidden');
            document.getElementById('btnCopy').onclick = () => { navigator.clipboard.writeText(''); alert('Veuillez consulter les instructions manuelles.'); };
          }
          // btnManual remains available to open manual instructions
          document.getElementById('btnManual').classList.remove('hidden');


          // No QR: use manual instructions button instead
          const manualBtn = document.getElementById('btnManual');
          if(ussd){
            const telURI = 'tel:' + encodeURIComponent(ussd);
            const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
            if(isMobile){ setTimeout(()=>{ window.location.href = telURI; }, 600); }
            if(manualBtn){ manualBtn.classList.remove('hidden'); manualBtn.classList.remove('ring-2','ring-red-300'); }
          } else {
            if(manualBtn){ manualBtn.classList.remove('hidden'); manualBtn.classList.add('ring-2','ring-red-300'); }
          }
          ussdArea.classList.remove('hidden');
        }

        if (tx) {
          // Afficher aussi le lien vers la page de statut (qui montrera PENDING)
          setTimeout(() => {
            window.location.href = `/deposit_status/${tx}`;
          }, 2000);
          return;
        }
      } else {
        // Affiche le message d'erreur
        msg.innerHTML = `
          <div class="bg-red-50 text-red-700 p-4 rounded-lg flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-times text-red-500"></i>
            </div>
            <div>
              <h4 class="font-medium">Erreur lors du paiement</h4>
              <p class="text-sm mt-1">${result.error || "Veuillez v√©rifier vos informations et r√©essayer."}</p>
            </div>
          </div>
        `;
      }
    } catch (err) {
      // Affiche l'erreur de connexion
      msg.innerHTML = `
        <div class="bg-red-50 text-red-700 p-4 rounded-lg flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-red-500"></i>
          </div>
          <div>
            <h4 class="font-medium">Erreur de connexion</h4>
            <p class="text-sm mt-1">Le serveur est inaccessible. Veuillez r√©essayer plus tard.</p>
          </div>
        </div>
      `;
    } finally {
      // R√©active le bouton et retire l'animation
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      submitBtn.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>D√©poser maintenant';
    }
});
</script>
{% endblock %}
